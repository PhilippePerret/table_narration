<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>/Users/philippeperret/Sites/table_narration/js/App.js</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title=""></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: </em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/App.html">App</a></li>
            
                <li><a href="../classes/App.Prefs.html">App.Prefs</a></li>
            
                <li><a href="../classes/Chapter.html">Chapter</a></li>
            
                <li><a href="../classes/Collection.html">Collection</a></li>
            
                <li><a href="../classes/ColText.html">ColText</a></li>
            
                <li><a href="../classes/ContextualHelp.html">ContextualHelp</a></li>
            
                <li><a href="../classes/DICO.html">DICO</a></li>
            
                <li><a href="../classes/Fiche.html">Fiche</a></li>
            
                <li><a href="../classes/FICHES.html">FICHES</a></li>
            
                <li><a href="../classes/FILMS.html">FILMS</a></li>
            
                <li><a href="../classes/Mot.html">Mot</a></li>
            
                <li><a href="../classes/ObjetClass.html">ObjetClass</a></li>
            
                <li><a href="../classes/OBJETS.html">OBJETS</a></li>
            
                <li><a href="../classes/OBJETS.Dom.html">OBJETS.Dom</a></li>
            
                <li><a href="../classes/Page.html">Page</a></li>
            
                <li><a href="../classes/Paragraph.html">Paragraph</a></li>
            
                <li><a href="../classes/PARAGRAPHES.html">PARAGRAPHES</a></li>
            
                <li><a href="../classes/Ref.html">Ref</a></li>
            
                <li><a href="../classes/REFS.html">REFS</a></li>
            
                <li><a href="../classes/UI.html">UI</a></li>
            
                <li><a href="../classes/UI.Input.html">UI.Input</a></li>
            
                <li><a href="../classes/window.html">window</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/app.html">app</a></li>
            
                <li><a href="../modules/app-prefs.html">app-prefs</a></li>
            
                <li><a href="../modules/Chapter.html">Chapter</a></li>
            
                <li><a href="../modules/Collection.html">Collection</a></li>
            
                <li><a href="../modules/ColText.html">ColText</a></li>
            
                <li><a href="../modules/ContextualHelp.html">ContextualHelp</a></li>
            
                <li><a href="../modules/Data.html">Data</a></li>
            
                <li><a href="../modules/data.html">data</a></li>
            
                <li><a href="../modules/Debug.html">Debug</a></li>
            
                <li><a href="../modules/DICO.html">DICO</a></li>
            
                <li><a href="../modules/DICO.js.html">DICO.js</a></li>
            
                <li><a href="../modules/Dom.html">Dom</a></li>
            
                <li><a href="../modules/dom.html">dom</a></li>
            
                <li><a href="../modules/Edition.html">Edition</a></li>
            
                <li><a href="../modules/edition.collection.js.html">edition.collection.js</a></li>
            
                <li><a href="../modules/Fiche.html">Fiche</a></li>
            
                <li><a href="../modules/fiche_data.html">fiche_data</a></li>
            
                <li><a href="../modules/fiche_dom.html">fiche_dom</a></li>
            
                <li><a href="../modules/FICHES.html">FICHES</a></li>
            
                <li><a href="../modules/FilmClass.html">FilmClass</a></li>
            
                <li><a href="../modules/FILMS.html">FILMS</a></li>
            
                <li><a href="../modules/Input.html">Input</a></li>
            
                <li><a href="../modules/jQueryExtension.html">jQueryExtension</a></li>
            
                <li><a href="../modules/KeyboardEvents.html">KeyboardEvents</a></li>
            
                <li><a href="../modules/KeyEvents.html">KeyEvents</a></li>
            
                <li><a href="../modules/Mot.html">Mot</a></li>
            
                <li><a href="../modules/OBJET.html">OBJET</a></li>
            
                <li><a href="../modules/ObjetClass.html">ObjetClass</a></li>
            
                <li><a href="../modules/objets.html">objets</a></li>
            
                <li><a href="../modules/OBJETS.Dom.html">OBJETS.Dom</a></li>
            
                <li><a href="../modules/Page.html">Page</a></li>
            
                <li><a href="../modules/Paragraph.html">Paragraph</a></li>
            
                <li><a href="../modules/PARAGRAPHS.html">PARAGRAPHS</a></li>
            
                <li><a href="../modules/ready.js.html">ready.js</a></li>
            
                <li><a href="../modules/ref.js.html">ref.js</a></li>
            
                <li><a href="../modules/REFS.js.html">REFS.js</a></li>
            
                <li><a href="../modules/String.html">String</a></li>
            
                <li><a href="../modules/UI.html">UI</a></li>
            
                <li><a href="../modules/window.html">window</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: /Users/philippeperret/Sites/table_narration/js/App.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/**
  * @module app
  */

/**
  * Sécurité pour empêcher de quitter la page quand des données n&#x27;ont pas été
  * enregistrées.
  *  
  * S&#x27;il n&#x27;y a aucune modification en cours, on sauve la configuration courante des
  * fiche pour récupérer le même état au relancement de l&#x27;application. Noter cependant
  * que si un “flash” d&#x27;une configuration a déjà été demandé, on ne procède pas
  * à l&#x27;enregistrement de la configuration.
  *
  * @method confirmExit
  * @param  {Event} Event beforeUnload généré.
  * @return Rien si la collection n&#x27;a pas été modifiée ou le texte à afficher
  *         pour confirmer de quitter la page. Mais à cause d&#x27;un bug de Firefox,
  *         ce texte ne s&#x27;affiche pas.
  * 
  */
function confirmExit(evt)
{
  if(Collection.modified)
  {
    evt.returnValue = &quot;Veux-tu vraiment quitter ?&quot;
    return &quot;Veux-tu vraiment quitter ?&quot;
  }
  else
  {
    // Ce n&#x27;est pas bon, apparemment, de faire ça. Ça produit une erreur, 
    // certainement parce qu&#x27;on lance une requête ajax en quittant la page
    // if(false == (App.flashed || MODE_TEST)) App.save_current_configuration(forcer = false)
  }
}
window.onbeforeunload = confirmExit

/**
  *	Pour la gestion de l&#x27;application
  *
  * @class App
  * @static
  *
  */
window.App = window.App || {}
$.extend(window.App, {
  
  /**
    * Clipboard (mémoire tampon) de l&#x27;application. Pour placer du texte qui 
    * devra ensuite être inséré dans le texte à l&#x27;aide de CMD+V.
    * Notes
    * -----
    *   * La valeur est soit un {String} à copier tel quel dans le texte, soit
    *     un {Object} qui doit obligatoirement répondre à la méthode &#x60;.to_balise&#x60;
    *     qui doit retourner le texte à coller dans le texte.
    *   * Utilisé par exemple pour les références
    *   * C&#x27;est la pseudo-méthode &#x60;App.coller_clipboard&#x60; qui répond au CMD+V
    *
    * @property clipboard
    * @type     {Object|String}
    * @default  null
    */
  clipboard:null,
  
  /**
    * Mis à TRUE si un flash de la configuration courante a été demandé. Pour 
    * empêcher d&#x27;en enregistrer un nouveau à la fermeture de la collection.
    * Noter cependant que de toute façon, il sera impossible d&#x27;enregistrer la 
    * configuration courante si un fichier de configuration (qui est supprimé à
    * chaque chargement) se trouve déjà créé (par un flash).
    *
    * @property flashed
    * @type     {Boolean}
    * @default  false
    */
  flashed:false,
  
  /**
    * Préférences de l&#x27;application
    *
    * Préférences
    * -----------
    *   * snap    Si true, les fiches sont disposées sur la grille
    *
    * Notes
    * -----
    *   * Cf. l&#x27;objet {Prefs} qui gère ces préférences
    *
    * @property preferences
    * @type     {Object}
    * @static
    * @default Les préférences par défaut
    */
  preferences:{
    snap        : true,   // place les fiches sur la grille
    autosave    : false,  // sauvegarde automatique
    saveconfig  : false   // sauvegarde de la config à chaque sauvegarde
  },
  
  
  /**
    * Enregistre la configuration d&#x27;ouverture (et de rangement) actuelle pour
    * la replacer au prochain chargement de l&#x27;application.
    * 
    * NOTES
    * -----
    *   * La méthode est appelée à chaque sauvegarde si les préférences l&#x27;exigent.
    *   * Envoi la requête Ajax pour créer le fichier &quot;current_config.config&quot;
    *   * Si une méthode doit suivre, renseigner avec cette méthode (proxy)
    *     &#x60;App.save_current_configuration.poursuivre&#x60;
    *
    * @method save_current_configuration
    * @async
    *
    * @param  forcer  {Boolean} Si TRUE (quand appelé depuis l&#x27;appareil photo),
    *                 on force la destruction du fichier configuration pour prendre
    *                 cette nouvelle configuration.
    * @param  rajax   {Object} Retourn de la requête ajax. Donc indéfini à l&#x27;appel
    *                 de la méthode.
    * 
    */
  save_current_configuration:function(forcer, rajax)
  {
    if(undefined == rajax)
    {
      Ajax.send(
        {script:&#x27;app/save_config&#x27;, config:this.current_config, force:forcer},
        $.proxy(this.save_current_configuration, this, forcer)
      )
    }
    else
    {
      if(rajax.ok)
      { 
        this.flashed = true
        if(&#x27;function&#x27;==typeof this.save_current_configuration.poursuivre) this.save_current_configuration.poursuivre()
        else F.show(&quot;Configuration courante enregistrée. Elle sera utilisée au prochain chargement de la table.&quot;)
      }
      else F.error(rajax.message)
    }
  },  
  
  // Jouer &#x27;App.ajax()&#x27; pour voir si le script ajax fonctionne
  ajax:function()
  {
    Ajax.send({
      script:&quot;app/test_ajax&quot;,
      data:{}
    }, $.proxy(this.suite_ajax, this))
  },
  suite_ajax:function(rajax)
  {
    if(rajax.ok) alert(&quot;Tout s&#x27;est bien passé en ajax&quot; +
    &quot;\n\nRuby version: &quot; + rajax.ruby_version)
  }
})

Object.defineProperties(App,{
  
  /**
    * Insert dans le texte le contenu du clipboard s&#x27;il n&#x27;est pas null.
    * S&#x27;il est null, renvoie FALSE pour que CMD+V agisse par défaut.
    * Notes
    * -----
    *   * Le App.clipboard est vidé dès qu&#x27;il est collé pour ne pas parasiter le
    *     comportement normal du coller-copier.
    *   * C&#x27;est une propriété complexe, donc l&#x27;appeler sans parenthèses.
    *   * Le &#x60;clipboard&#x60; peut être soit un simple {String} soit un {Object} répondant
    *     à la méthode &#x60;.to_balise&#x60; (comme les références).
    *
    * @method coller_clipboard
    *
    */
  &quot;coller_clipboard&quot;:{
    get:function(){
      dlog(&quot;-&gt; App.coller_clipboard&quot;, DB_FCT_ENTER)
      if(this.clipboard == null) return false
      var clip ;
      if(&#x27;string&#x27;==typeof this.clipboard) clip = this.clipboard.toString()
      else clip = this.clipboard.to_balise
      UI.Input.set_selection_to( clip )
      this.clipboard = null
      CHelp.adapt_with_fiche_active // pour actualiser les raccourcis actifs
      dlog(&quot;&lt;- App.coller_clipboard&quot;, DB_FCT_ENTER)
      return true
    }
  },
  /**
    * Pour passer en mode test
    *
    * Notes
    * -----
    *   * C&#x27;est une propriété complexe, donc appeler sans parenthèses
    *   * La méthode ouvre l&#x27;application Pure-JS-Tests.
    *
    * @method mode_test
    */
  &quot;mode_test&quot;:{
    get:function(){
      window.open(&#x27;./tests.php&#x27;, &quot;pure_js_test&quot;)
      F.show(&quot;Penser à quitter le mode test en finissant, par commodité.&quot;, {keep:true})
    }
  },
  /**
    * Analyse la configuration actuelle (ouvertures et rangements) et retourne
    * un {Object} à enregistrer dans le fichier de configuration courante.
    *
    * NOTES
    * -----
    *   * Pour procéder, cette propriété/méthode regarde simplement les fiches
    *     qui sont on_table sur la table.
    *
    * @property current_config
    * @return   {Object} Configuration courante, contenant &#x60;on_table&#x27;, les fiches
    *           actuellement on_table (sur la table) et &#x60;openeds&#x27;, les fiches
    *           actuellement ouvertes (opened = true)
    *
    */
  &quot;current_config&quot;:{
    get:function(){
      var config = {
        openeds     : [],
        on_table    : [],
        orphelines  : []
      }
      /* Pour écarter certaines erreurs, je tiens à jour une table des
       * fiches traitées. Ça évitera d&#x27;enregistrer deux fois une même fiche
       * comme ouverte.
       */
      var table_fiches_traited = {}
      $(&#x27;section#table &gt; fiche:visible&#x27;).each(function(){
        var fiche = FICHES.domObj_to_fiche($(this))
        if(table_fiches_traited[fiche.id])
        {
          F.error(&quot;La fiche &quot;+fiche.type_id+&quot; se trouve en double sur la table…&quot;, {keep:true})
          return
        }
        else
        {
          table_fiches_traited[fiche.id] = true
        }
        var datam = {id:fiche.id, type:fiche.type}
        config.on_table.push(datam)
        if(fiche.opened) config.openeds.push(datam)
        if(fiche.is_not_book &amp;&amp; fiche.is_orpheline) config.orphelines.push(datam)
      })
      return JSON.stringify(config)
    }
  },
  
  /**
    * Applique la configuration courante. En d&#x27;autres termes, ouvre les fiches qui
    * doivent être ouvertes (en les sortant de leur parent si nécessaire).
    *
    * @method current_configuration
    *
    */
  &quot;current_configuration&quot;:{
    set:function(conf){
      this._current_configuration = conf
      if(conf == null) return
      var errors = [], fiche ;
      // On ouvre les fiches qui doivent l&#x27;être
      // @note : c&#x27;est une procédure qui ne doit pas être asynchrone, car tous
      // les éléments nécessaire ont dû être remontés.
      L(conf.openeds).each(function(fdata){
        if(undefined == FICHES.list[fdata.id]) errors.push(&quot;La fiche #&quot;+fdata.id+&quot; devrait exister…&quot;)
        else
        {
          fiche = get_fiche(fdata.id)
          // Si c&#x27;est une page, et que son livre est fermé, il faut ouvrir le livre,
          // pour afficher la table des matières, et enfin ouvrir la page.
          if(fiche.is_page &amp;&amp; fiche.book &amp;&amp; fiche.book.closed)
          {
            fiche.book.open
            refermer_book = true
          } 
          else refermer_book = false
          fiche.open
          if(refermer_book) fiche.book.close
        } 
      })
      // Juste pour voir, on regarde si les fiches visibles sont bien visibles
      L(conf.on_table).each(function(fdata){
        if($(&#x27;section#table &gt; fiche#f-&#x27;+fdata.id).length == 0) errors.push(&quot;La fiche #&quot;+fdata.id+&quot; devrait être visible.&quot;)
      })
      if(errors.length)
      {
        F.error(LOCALE.app.error[&#x27;current config error&#x27;]+errors.join(&quot;\n\t&quot;))
      }
    }
  }
  
})
    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
