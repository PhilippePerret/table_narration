<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>/Users/philippeperret/Sites/table_narration/js/required/Fiche_class.js</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title=""></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: </em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/App.html">App</a></li>
            
                <li><a href="../classes/Collection.html">Collection</a></li>
            
                <li><a href="../classes/ColText.html">ColText</a></li>
            
                <li><a href="../classes/ContextualHelp.html">ContextualHelp</a></li>
            
                <li><a href="../classes/DICO.html">DICO</a></li>
            
                <li><a href="../classes/Fiche.html">Fiche</a></li>
            
                <li><a href="../classes/FICHES.html">FICHES</a></li>
            
                <li><a href="../classes/FILMS.html">FILMS</a></li>
            
                <li><a href="../classes/Mot.html">Mot</a></li>
            
                <li><a href="../classes/ObjetClass.html">ObjetClass</a></li>
            
                <li><a href="../classes/OBJETS.html">OBJETS</a></li>
            
                <li><a href="../classes/PARAGRAPHES.html">PARAGRAPHES</a></li>
            
                <li><a href="../classes/UI.html">UI</a></li>
            
                <li><a href="../classes/UI.Input.html">UI.Input</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/App.js.html">App.js</a></li>
            
                <li><a href="../modules/Collection.html">Collection</a></li>
            
                <li><a href="../modules/ColText.html">ColText</a></li>
            
                <li><a href="../modules/ContextualHelp.html">ContextualHelp</a></li>
            
                <li><a href="../modules/Data.html">Data</a></li>
            
                <li><a href="../modules/data.html">data</a></li>
            
                <li><a href="../modules/Debug.html">Debug</a></li>
            
                <li><a href="../modules/DICO.html">DICO</a></li>
            
                <li><a href="../modules/DICO.js.html">DICO.js</a></li>
            
                <li><a href="../modules/dom.html">dom</a></li>
            
                <li><a href="../modules/Dom.html">Dom</a></li>
            
                <li><a href="../modules/Edition.html">Edition</a></li>
            
                <li><a href="../modules/fiche.dom.html">fiche.dom</a></li>
            
                <li><a href="../modules/FicheClass.html">FicheClass</a></li>
            
                <li><a href="../modules/FICHES.html">FICHES</a></li>
            
                <li><a href="../modules/FilmClass.html">FilmClass</a></li>
            
                <li><a href="../modules/FILMS.html">FILMS</a></li>
            
                <li><a href="../modules/HandyMethods.html">HandyMethods</a></li>
            
                <li><a href="../modules/Input.html">Input</a></li>
            
                <li><a href="../modules/jQueryExtension.html">jQueryExtension</a></li>
            
                <li><a href="../modules/KeyboardEvents.html">KeyboardEvents</a></li>
            
                <li><a href="../modules/KeyEvents.html">KeyEvents</a></li>
            
                <li><a href="../modules/Mot.html">Mot</a></li>
            
                <li><a href="../modules/ObjetClass.html">ObjetClass</a></li>
            
                <li><a href="../modules/OBJETS.html">OBJETS</a></li>
            
                <li><a href="../modules/PARAGRAPHS.html">PARAGRAPHS</a></li>
            
                <li><a href="../modules/ready.js.html">ready.js</a></li>
            
                <li><a href="../modules/String.html">String</a></li>
            
                <li><a href="../modules/UI.html">UI</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: /Users/philippeperret/Sites/table_narration/js/required/Fiche_class.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/**
  * @module FicheClass
  */

/**
  *  Class Fiche
  *  -----------
  *
  *  Toutes les instances Book, Page, Chapter et Paragraph héritent d&#x27;elle
  *
  *
  *  RAPPELS
  *  -------
  *    * C&#x27;est en ajoutant un enfant à une fiche qu&#x27;on détermine les propriétés
  *      &#x60;parent&#x27; et &#x60;enfants&#x27; des deux fiches concernant.
  *      cf. la méthode &quot;add_enfant&quot;.
  *
  * @class  Fiche
  *
  */
window.Fiche = function(data)
{
  dlog(&quot;---&gt; Fiche (instanciation)&quot;, DB_FCT_ENTER)
  
  this.class      = &quot;Fiche&quot;
  this.id         = null
  this.created_at = null
  this.type       = null      // le type, entre &#x27;book&#x27;, &#x27;page&#x27;, &#x27;chap&#x27;, &#x27;para&#x27;
  
  // --- State ---
  // (ci-dessous les valeurs par défaut)
  this.loaded     = false   // Mis à true si elle est entièrement chargée
  this.deleted    = false
  this._opened    = false   // cf. propriété complexe &#x60;opened&#x27;
  this._ranged    = false   // cf. propriété complexe &#x60;ranged&#x27;
  this.selected   = false
  this.built      = false   // mis à true quand la fiche est construite
  this.retourned  = false   // Mis à true quand c&#x27;est le verso affiché
  this.draggable  = false
  this.sortable   = false
  if(undefined == data) data = {}
  
  // Nouvelle fiche ?
  // @note: Il faut le faire avant que ne soient dispatchées les valeurs,
  // car la définition de ces valeurs fait appel à d&#x27;autres méthodes qui
  // utilisent l&#x27;identifiant (par exemple les méthodes de type &#x60;_jid&#x27;)
  if(undefined == data.id || data.id == null) 
  {
    this.created_at = Time.now()
    this.id = ++ FICHES.last_id
    this.loaded = true
  }
  
  this.dispatch( data )
  
  FICHES.add( this )
  dlog(&quot;&lt;- Fiche (instanciation)&quot;, DB_FCT_ENTER)
  
}

Object.defineProperties(Fiche.prototype, {
  
  /* ---------------------------------------------------------------------
   *      DONNÉES DE LA FICHE
   --------------------------------------------------------------------- */
  /**
    *  Retourne un {Array} des minidata des enfants 
    *
    * @property enfants_as_minidata
    * @type     {Array}
    * @default  []
    *
    */
  &quot;enfants_as_minidata&quot;:{
    get:function(){
      arr = []
      for(var i in this.enfants){ 
        arr.push(this.enfants[i].minidata)
      }
      return arr
    }
  },

  /* ---------------------------------------------------------------------
   *      PROPRIÉTÉS D&#x27;ÉTAT
   --------------------------------------------------------------------- */
  &quot;modified&quot;:{
    set:function(val){ 
      this._modified      = val;
      if(val) Collection.add_modified( this ) ;
    },
    get:function(){return this._modified || false }
  },
  
  /*
   *  Marque la fiche ouverte ou fermé (ou retourne la propriété)
   *  
   */
  &quot;opened&quot;:{
    get:function(){ return this._opened || false },
    set:function(opened){
      this._opened = opened
      this.obj[opened?&#x27;addClass&#x27;:&#x27;removeClass&#x27;](&#x27;opened&#x27;)
    }
  },

  /*
   *  Marque l&#x27;élément rangé ou non rangé (ou retourne la propriété ranged)
   *  
   */
  &quot;ranged&quot;:{
    get:function(){ return this._ranged || false },
    set:function(ranged){
      this._ranged = ranged
      this.obj[ranged?&#x27;addClass&#x27;:&#x27;removeClass&#x27;](&#x27;ranged&#x27;)
    }
  },

  /* ---------------------------------------------------------------------
   */
  /*
   *  Vérifie si la fiche peut être ouverte
   *  Pour être ouverte, la fiche doit être &#x60;loaded&#x27; et ses enfants doivent
   *  l&#x27;être aussi.
   *
   *  NOTES
   *  -----
   *    = Les enfants, dans la fiche, sont toujours des instances Fiche.
   *      (réglées au chargement du parent). C&#x27;est leur propriété &#x60;loaded&#x27;
   *      qui détermine si elles sont chargées ou non.
   *
   *    = On peut appeler la méthode &#x60;rend_openable(&lt;poursuivre&gt;)&#x27; pour rendre
   *      la fiche ouvrable après le test &#x60;&lt;fiche&gt;.is_not_openable&#x27;
   */
  &quot;is_openable&quot;:{
    get:function(){
      var i = 0, ichild ;
      if(this.is_paragraph) return true ; // toujours ouvrable
      if(this.loaded == false) return false ;
      if(!this.enfants || this.enfants == []) return true ;
      for(len = this.enfants.length; i&lt;len; ++i)
      {
        ichild = this.enfants[i]
        if(false == (ichild.loaded &amp;&amp; ichild.built) ) return false
      }
      // Si on arrive ici, c&#x27;est que tous les éléments ont été chargés
      return true
    }
  },
  &quot;is_not_openable&quot;:{
    get:function(){return this.is_openable == false}
  },
    
  /*
   *  Positionne la fiche sur le table en fonction de :
   *    - son état ranged ou non
   *    - ses top / left
   */
  &quot;positionne&quot;:{
    get:function(){
      if( this.ranged || this.top == null || !this.obj ) return
      this.obj.css({&#x27;top&#x27;:this.top+&quot;px&quot;, &#x27;left&#x27;:this.left+&quot;px&quot;})
    }
  },
  
  /*
   *  Création d&#x27;une nouvelle fiche
   *  -----------------------------
   *  
   *  NOTES
   *  -----
   *  * Il ne suffit pas de créer la fiche pour qu&#x27;elle soit mise en 
   *    sauvegarde. Cela permet de les créer tranquillement lors du chargement
   *    de la collection.
   *    C&#x27;est seulement lorsqu&#x27;un élément de la fiche aura été modifié (et
   *    notamment le titre ou le texte — paragraph) qu&#x27;elle sera prête pour
   *    l&#x27;enregistrement.
   */
  &quot;create&quot;:{
    get:function(){
      dlog(&quot;---&gt; Fiche::create (&quot;+this.type_id+&quot;)&quot;, DB_FCT_ENTER)
      this.build
      this.set_values
      dlog(&quot;&lt;- Fiche::create (&quot;+this.type_id+&quot;)&quot;, DB_FCT_ENTER)
      return true
    }
  },
  
  /*
   *  Construction de la fiche sur la table
   *  
   */
  &quot;build&quot;:{
    get:function(){
      var idm = &quot;Fiche::build [&quot;+this.type_id+&quot;]&quot; ;
      dlog(&quot;---&gt; &quot; + idm, DB_FCT_ENTER)
      // On ajoute le code ou on le remplace
      if(this.obj) this.obj.replaceWith( this.html )
      else         $(&#x27;section#table&#x27;).append( this.html )
      // On place les observers
      this.observe
      // On marque la fiche construite
      this.built = true
      dlog(&quot;&lt;- &quot; + idm, DB_FCT_ENTER)
      return true
    }
  },
  
  /*
   *  Place tous les OBSERVERS sur la fiche
   *  
   */
  &quot;observe&quot;:{
    get:function(){
      var idm = &quot;Fiche::observe [&quot;+this.type_id+&quot;]&quot; ;
      dlog(&quot;---&gt; &quot; + idm, DB_FCT_ENTER)
      var obj ;
      
      // Rend la fiche draggable
      this.rend_draggable
      
      // Un click sur la fiche doit la sélectionner/déselectionner
      // Mais seulement en recto
      this.active_click_on_fiche

      // Le click sur la fiche, en combinaison avec des modifiers,
      // doit entrainer différents résultats (pour le moment, avec 
      // CMD, on met le titre/texte en édition)
      this.main_field.bind(&#x27;click&#x27;, $.proxy(FICHES.on_click_on_main_field, FICHES, this))

      if(this.is_book)
      {
        // La modification du titre réel doit entrainer son update
        // obj = this.input_real_titre
        // obj.bind(&#x27;focus&#x27;, $.proxy(FICHES.onfocus_textfield, FICHES, this))
        // obj.bind(&#x27;blur&#x27;, $.proxy(FICHES.onblur_textfield, FICHES, this))
        // this.input_real_titre[0].onchange = $.proxy(this.onchange_real_titre, this)
        UI.Input.bind( this.input_real_titre )
      }
      // Toutes les fiches hors paragraphes doivent être droppable et
      // accepter un élément de rang inférieur
      var accepted_child = FICHES.datatype[this.type].child_type
      if(this.is_not_paragraph)
      {
        this.obj.droppable({
          hoverClass  :&#x27;dropped&#x27;,
          accept      : &#x27;.fiche.&#x27;+accepted_child+
                        &#x27;, .card_tool[data-type=&quot;&#x27;+accepted_child+&#x27;&quot;]&#x27;,
          drop        :$.proxy(this.on_drop, this)
        })
      }
      dlog(&quot;&lt;- &quot; + idm, DB_FCT_ENTER)
      return true
    }
  },
  &quot;active_click_on_fiche&quot;:{
    get:function(){
      // this.obj.bind(&#x27;click&#x27;, $.proxy(this.toggle_select, this))
      this.recto.bind(&#x27;click&#x27;, $.proxy(this.toggle_select, this))
      this.verso.bind(&#x27;click&#x27;, function(evt){evt.stopPropagation();return true})
    }
  },
  &quot;desactive_click_on_fiche&quot;:{
    get:function(){
      // this.obj.unbind(&#x27;click&#x27;, $.proxy(this.toggle_select, this))
      this.recto.unbind(&#x27;click&#x27;, $.proxy(this.toggle_select, this))
    }
  },
  /*
   *  Rend la fiche sortable (lorsqu&#x27;elle est rangée)
   *  
   */
  &quot;rend_sortable&quot;:{
    get:function(){
      this.obj.sortable({
        // &#x27;containment&#x27;: this.parent.div_items,
        &#x27;axis&#x27;    : &#x27;y&#x27;,
        &#x27;opacity&#x27; : 0.5,
        &#x27;scroll&#x27;  : true,
        &#x27;change&#x27;  : function(evt, ui)
        {
          /* appelé si changement de position*/
          dlog(this.type_id+&quot; a changé de position&quot;)
          return true
        },
        &#x27;out&#x27; :function(evt,ui)
        {
          dlog(this.type_id+&quot; sort de son parent&quot;)
        },
        &#x27;over&#x27;:function(evt,ui)
        {
          dlog(this.type_id+&quot; passe sur une liste qui peut l&#x27;accepter&quot;)
        },
        &#x27;start&#x27;:function(evt,ui)
        {
          dlog(&quot;Début du déplacement (sort) de &quot;+this.type_id)
        },
        &#x27;stop&#x27;:function(evt,ui)
        {
          dlog(&quot;Fin du déplacement (sort) de &quot;+this.type_id)
        }
      })
      this.sortable = true
    }
  },
  /*
   *  Rend la fiche draggable (lorsqu&#x27;elle est posée sur la table)
   *  
   */
  &quot;rend_draggable&quot;:{
    get:function(){
      var idm = &quot;Fiche::rend_draggable (&quot;+this.type_id+&quot;)&quot;
      dlog(&quot;---&gt; &quot;+idm, DB_FCT_ENTER)
      this.obj.draggable({
        containment:&#x27;parent&#x27;,
        stop: $.proxy(this.stop_drag, this)
      })
      this.draggable = true
      dlog(&quot;&lt;- &quot;+idm, DB_FCT_ENTER)
    }
  },

  /*
   *  Rend la fiche &quot;ouvrable&quot;
   *  (en chargeant ses données au besoin et ses enfants)
   *  
   *  @param  poursuivre    SOIT une fonction pour poursuivre, 
   *                        SOIT un {String} qui sera une pseudo-méthode (propriété
   *                        complexe) de la fiche elle-même.
   *                        SOIT un {Object} contenant :
   *                        {id:&lt;id de la fiche&gt;, prop:&lt;propriété complexe&gt;}
   */
  &quot;rend_openable&quot;:{
    value:function(poursuivre){
      var idm = &quot;Fiche::rend_openable [&quot;+this.type_id+&quot;]&quot; 
      dlog(&quot;---&gt; &quot;+idm, DB_FCT_ENTER)
      if(&#x27;string&#x27; == typeof poursuivre) poursuivre = {id:this.id, prop:poursuivre}
      FICHES.after_load.poursuivre = poursuivre
      FICHES.load( this.enfants_as_minidata )
      dlog(&quot;&lt;- &quot;+idm, DB_FCT_ENTER)
    }
  },
  
  /*
   *  Toggle (ouvre/ferme) la fiche
   *  
   */
  &quot;toggle&quot;:{
    get:function(){
      this.opened ? this.close : this.open
    }
  },
  
  /*
   *  Ouvre la fiche
   *  --------------
   *
   *  NOTES
   *  -----
   *    # L&#x27;opération produit des résultats différents en fonction du type
   *      de la fiche. Par exemple, pour une page, on la sort de son parent
   *      et on montre ses enfants (paragraphes). Pour un chapitre, on ne
   *      fait que mettre son titre en édition.
   */
  &quot;open&quot;:{
    get:function(){
      var idm = &quot;Fiche::open [&quot;+this.type_id+&quot;]&quot; 
      dlog(&quot;---&gt; &quot;+idm, DB_FCT_ENTER)
      if(this.is_not_openable) return this.rend_openable(&#x27;open&#x27;)
      this.opened = true
      if(this.is_page &amp;&amp; this.ranged) this.unrange
      dlog(&quot;&lt;- &quot;+idm, DB_FCT_ENTER)
    }
  },
  /*
   *  Ferme la fiche
   *  --------------
   *
   *  NOTES
   *  -----
   *    # En mode fermé, le titre est disabled
   *
   */
  &quot;close&quot;:{
    get:function(){
      var idm = &quot;Fiche::close [&quot;+this.type_id+&quot;]&quot;
      dlog(&quot;---&gt; &quot;+idm, DB_FCT_ENTER)
      if(this.retourned) this.retourne
      this.opened = false
      if(this.is_page &amp;&amp; this.parent) this.range
      dlog(&quot;&lt;- &quot;+idm, DB_FCT_ENTER)
    }  
  },
  
  /*
   *  Range la fiche
   *  
   *  NOTES
   *  -----
   *  * La fiche peut avoir un clone dans son parent, qu&#x27;il faut alors
   *    supprimer.
   *  * On supprime le draggable de la fiche et on ajoute un sortable
   *
   */
  &quot;range&quot;:{
    get:function(){
      var idm = &quot;Fiche::range [&quot;+this.type_id+&quot;]&quot;
      dlog(&quot;---&gt; &quot;+idm, DB_FCT_ENTER)
      if(!this.parent) throw LOCALE.fiche.error[&#x27;unable to range orphelin&#x27;]
      if(this.obj_clone.length) this.unclone
      else this.parent.div_items.append( this.obj )
      if(this.draggable)
      {
        this.obj.draggable(&quot;destroy&quot;)
        this.draggable = false
      }
      this.rend_sortable
      this.ranged = true
      dlog(&quot;&lt;- &quot;+idm, DB_FCT_ENTER)
    }
  },
  /*
   *  Sort la fiche de son rangement
   *  
   */
  &quot;unrange&quot;:{
    get:function(){
      if(!this.parent) throw LOCALE.fiche.error[&#x27;unable to unrange orphelin&#x27;]
      this.clone
      if(this.sortable)
      {
        this.obj.sortable(&quot;destroy&quot;)
        this.sortable = false
      }
      this.rend_draggable
      this.ranged = false
    }
  },
  
  
  /*
   *  Retourne la fiche
   *  
   */
  &quot;retourne&quot;:{
    get:function()
    {
      this.recto[this.retourned ? &#x27;show&#x27; : &#x27;hide&#x27;]()
      this.verso[this.retourned ? &#x27;hide&#x27; : &#x27;show&#x27;]()
      this.retourned = !this.retourned
      if(this.retourned) this.regle_verso
    }
  },  
  
  /*
   *  Destruction totale d&#x27;une fiche
   *  
   */
  &quot;remove&quot;:{
    configurable:true,
    get:function(){
      this.obj.remove()
      this.delete ;
    }
  },
  
  /*
   *  Volonté de supprimer la fiche (confirmation)
   *
   *  Si la confirmation est demandée, la méthode &quot;delete&quot; est vraiment appelée  
   */
  &quot;want_delete&quot;:{
    get:function(){
      Edit.show({
        id:&#x27;kill_fiche&#x27;,
        title: LOCALE.fiche[&#x27;want delete fiche&#x27;],
        fields:{
          kill_children:{type:&#x27;checkbox&#x27;, value:&quot;true&quot;, libelle:LOCALE.fiche[&#x27;kill children&#x27;], checked:false}
        },
        buttons:{
          cancel:{name:&quot;Renoncer&quot;},
          ok:{name:&quot;Détruire la fiche&quot;, onclick:$.proxy(FICHES.remove, FICHES, this)}
        }
      })
    }
  },
  /*
   *  Suppression d&#x27;une fiche
   *  
   *  NOTE: CETTE PROPRIÉTÉ NE DOIT PAS ÊTRE APPELÉE
   *        Il faut appeler &lt;fiche&gt;.want_delete (qui appelle ensuite FICHES.remove)
   */
  &quot;delete&quot;:{
    get:function(){
      this.deleted  = true
      this.modified = true
      this.obj.remove()
    }
  }  
})

/*
 *  Appelé quand on droppe un enfant sur la fiche courante
 *  
 *  @param  evt   L&#x27;évènement drop
 *  @param  ui    L&#x27;objet déplacé (ui.element est l&#x27;original)
 *                Note : l&#x27;original peut être soit une fiche réelle, soit
 *                un card-tool. Lorsque c&#x27;est une card-tool, il faut créer la
 *                nouvelle fiche.
 */
Fiche.prototype.on_drop = function(evt, ui)
{
  var idm = &quot;Fiche::on_drop [&quot;+this.type_id+&quot;]&quot;
  dlog(&quot;---&gt; &quot;+idm, DB_FCT_ENTER | DB_CURRENT )
  UI.drop_on_fiche = true
  
  var obj_moved = ui.draggable
  var ichild
  var is_tool   = obj_moved.hasClass(&#x27;card_tool&#x27;) ;
  
  if(is_tool)
  {
    // On crée la fiche
    ichild = FICHES.full_create({
      type: obj_moved.attr(&#x27;data-type&#x27;),
      left: 100, top: 100
    })
  }
  else
  {
    ichild = FICHES.domObj_to_fiche( obj_moved )
  }
  this.add_child( ichild )
  
  // Si cette fiche parent est fermée, il faut l&#x27;ouvrir
  if(false == this.opened) this.open
  
  // TODO: Plus tard, on pourra regarder si la fiche a été déposé à un
  // endroit précis, pour le placer au bon endroit dans les enfants
  // F.error(&quot;La méthode Fiche.on_drop doit être implémentée&quot;+
  // &quot;\nÉlément #&quot;+obj_moved.attr(&#x27;id&#x27;)+&quot; (outil ? &quot;+is_tool+&quot;) glissé sur fiche #&quot;+this.id)
  
  return stop_event( evt )
}

$.extend(Fiche.prototype,{
  
  /*
   *  Actualise l&#x27;indice des enfants
   *
   *  NOTES
   *  -----
   *    = L&#x27;indice des enfants (0-start) est une propriété volatile
   *      utile à quelques méthodes, par exemple l&#x27;insertion d&#x27;enfants
   *      à un endroit précis.
   *  
   */
  update_indice_enfants:function(from)
  {
    if(undefined == from) from = 0
    for(var ichild = from, len=this.enfants.length; ichild&lt;len; ++ichild)
    {
      this.enfants[ichild].indice = parseInt(ichild, 10)
    }
  },
  
  /*
   *  Ajout d&#x27;un enfant à la fiche
   *
   *  NOTES
   *  -----
   *    = C&#x27;est cette méthode qui doit être utilisée pour tout ajout
   *      d&#x27;enfant.
   *
   *  @param  enfant    {Fiche} de l&#x27;enfant à ajouter
   *  @param  options   {Hash} Options d&#x27;insertion :
   *                      after  : &lt;fiche&gt;    Ajouter après cet enfant
   *                      before : &lt;fiche&gt;    Ajouter avant cet enfant
   */
  add_child:function(enfant, options)
  {
    if(undefined == options) options = {}
    try
    {
      if(!enfant || &#x27;object&#x27;!=typeof enfant)  throw &#x27;child should be an object&#x27;
      if( enfant.class != &#x27;Fiche&#x27;)            throw &#x27;child should be a fiche&#x27;
      thislevel = FICHES.datatype[this.type].level ;
      chillevel = FICHES.datatype[enfant.type].level ;
      if( thislevel &lt;= chillevel )            throw &#x27;child bad type&#x27;
    }
    catch(err){throw LOCALE.fiche.error[err]}
  
    // Ajout de l&#x27;enfant à la liste
    if(this.enfants == null)
    {
      enfant.indice = 0
      this.enfants  = [enfant]
    } 
    else
    {
      if(options.after || options.before){
        var indice = options.after ? options.after.indice + 1 : options.before.indice
        this.enfants.splice(indice, 0, enfant)
        this.update_indice_enfants(from = indice)
      }
      else {
        enfant.indice = this.enfants.length
        this.enfants.push( enfant )
      }
    }
  
    // Définition du parent de l&#x27;enfant
    enfant.parent = this
  
    if(enfant.opened) enfant.close
  
    /*
     *  Placement de l&#x27;objet DOM
     *  
     */
    if(options.after)
    { 
      enfant.obj.insertAfter( options.after.obj )
    }
    else if(options.before)
    { // =&gt; Ajout avant l&#x27;enfant before_child
      enfant.obj.insertBefore( options.before.obj )
    }
    else {
      this.div_items.append( enfant.obj )
    }
  
  
    this.modified   = true
    enfant.ranged   = true
    enfant.modified = true
    
  },
  
  /*
   *  Supprime un enfant 
   *  
   */
  remove_child:function(enfant)
  {
    try
    {
      // L&#x27;enfant doit être du bon type
      if(&#x27;object&#x27; != typeof enfant || enfant.class != &#x27;Fiche&#x27;) throw &#x27;child should be a fiche&#x27;;

      // On va vérifier que l&#x27;enfant soit bien celui qu&#x27;il prétend être
      if(enfant.parent != this) throw &#x27;is not child&#x27;
      var childcheck = this.enfants[enfant.indice]
      if(childcheck != enfant) throw &#x27;is not child&#x27;
    }
    catch(err){ throw LOCALE.fiche.error[err] }
  
    this.enfants.splice(enfant.indice, 1)
    enfant._parent = null

    this.modified   = true
    enfant.modified = true

    // Actualisation de l&#x27;indice des enfants suivants
    this.update_indice_enfants(from = enfant.indice)
    
    // On peut retirer l&#x27;enfant de la liste
    if(enfant.ranged == false) enfant.range
    $(&#x27;section#table&#x27;).append( enfant.obj )
    enfant.positionne
    
  },
  
  /*
   *  Méthode appelée quand on change le titre de la fiche
   *  
   *  NOTES
   *  -----
   *  @ Cela peut se produire lorsqu&#x27;on quitte le champ, ou lorsque
   *    l&#x27;on presse la touche RETURN sur le champ.
   *
   *  @ C&#x27;est vraiment cette fonction qui inaugure le changement du
   *    titre, car si c&#x27;était &#x60;titre=&#x60; (propriété complexe), on aura
   *    une difficulté à la définition des fiches remontées.
   *
   */
  onchange_titre_or_texte:function(evt)
  {
    var idm = &quot;Fiche::onchange_titre_or_texte [&quot;+this.type_id+&quot;]&quot;
    dlog(&quot;---&gt; &quot;+idm, DB_FCT_ENTER)
    var obj=this.main_field, prop=this.main_prop ;
    var new_value = obj.val()
    if(this[prop] != new_value)
    {
      this[prop]    = new_value
      this.modified = true    
    }
    if(this.is_chapter) this.close
    dlog(&quot;&lt;- &quot;+idm, DB_FCT_ENTER)
  }
  
})


/*
 *  Appelé à la fin du drag d&#x27;une fiche
 *  
 */
Fiche.prototype.stop_drag = function(evt, ui){
  var pos = this.obj.position()
  pos_on_grid = UI.position_on_grid([pos.left, pos.top], evt.metaKey)
  this.left = pos_on_grid.left
  this.top  = pos_on_grid.top
  this.positionne
  this.modified = true
}

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
