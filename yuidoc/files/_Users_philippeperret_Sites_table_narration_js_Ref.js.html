<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>/Users/philippeperret/Sites/table_narration/js/Ref.js</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title=""></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: </em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/App.html">App</a></li>
            
                <li><a href="../classes/App.Prefs.html">App.Prefs</a></li>
            
                <li><a href="../classes/Chapter.html">Chapter</a></li>
            
                <li><a href="../classes/Collection.html">Collection</a></li>
            
                <li><a href="../classes/ColText.html">ColText</a></li>
            
                <li><a href="../classes/ContextualHelp.html">ContextualHelp</a></li>
            
                <li><a href="../classes/DICO.html">DICO</a></li>
            
                <li><a href="../classes/Fiche.html">Fiche</a></li>
            
                <li><a href="../classes/FICHES.html">FICHES</a></li>
            
                <li><a href="../classes/FILMS.html">FILMS</a></li>
            
                <li><a href="../classes/Mot.html">Mot</a></li>
            
                <li><a href="../classes/ObjetClass.html">ObjetClass</a></li>
            
                <li><a href="../classes/OBJETS.html">OBJETS</a></li>
            
                <li><a href="../classes/OBJETS.Dom.html">OBJETS.Dom</a></li>
            
                <li><a href="../classes/Page.html">Page</a></li>
            
                <li><a href="../classes/Paragraph.html">Paragraph</a></li>
            
                <li><a href="../classes/PARAGRAPHES.html">PARAGRAPHES</a></li>
            
                <li><a href="../classes/Ref.html">Ref</a></li>
            
                <li><a href="../classes/REFS.html">REFS</a></li>
            
                <li><a href="../classes/UI.html">UI</a></li>
            
                <li><a href="../classes/UI.Input.html">UI.Input</a></li>
            
                <li><a href="../classes/window.html">window</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/app.html">app</a></li>
            
                <li><a href="../modules/app-prefs.html">app-prefs</a></li>
            
                <li><a href="../modules/Chapter.html">Chapter</a></li>
            
                <li><a href="../modules/Collection.html">Collection</a></li>
            
                <li><a href="../modules/ColText.html">ColText</a></li>
            
                <li><a href="../modules/ContextualHelp.html">ContextualHelp</a></li>
            
                <li><a href="../modules/Data.html">Data</a></li>
            
                <li><a href="../modules/data.html">data</a></li>
            
                <li><a href="../modules/Debug.html">Debug</a></li>
            
                <li><a href="../modules/DICO.html">DICO</a></li>
            
                <li><a href="../modules/DICO.js.html">DICO.js</a></li>
            
                <li><a href="../modules/Dom.html">Dom</a></li>
            
                <li><a href="../modules/dom.html">dom</a></li>
            
                <li><a href="../modules/Edition.html">Edition</a></li>
            
                <li><a href="../modules/edition.collection.js.html">edition.collection.js</a></li>
            
                <li><a href="../modules/Fiche.html">Fiche</a></li>
            
                <li><a href="../modules/fiche_data.html">fiche_data</a></li>
            
                <li><a href="../modules/fiche_dom.html">fiche_dom</a></li>
            
                <li><a href="../modules/FICHES.html">FICHES</a></li>
            
                <li><a href="../modules/FilmClass.html">FilmClass</a></li>
            
                <li><a href="../modules/FILMS.html">FILMS</a></li>
            
                <li><a href="../modules/Input.html">Input</a></li>
            
                <li><a href="../modules/jQueryExtension.html">jQueryExtension</a></li>
            
                <li><a href="../modules/KeyboardEvents.html">KeyboardEvents</a></li>
            
                <li><a href="../modules/KeyEvents.html">KeyEvents</a></li>
            
                <li><a href="../modules/Mot.html">Mot</a></li>
            
                <li><a href="../modules/OBJET.html">OBJET</a></li>
            
                <li><a href="../modules/ObjetClass.html">ObjetClass</a></li>
            
                <li><a href="../modules/objets.html">objets</a></li>
            
                <li><a href="../modules/OBJETS.Dom.html">OBJETS.Dom</a></li>
            
                <li><a href="../modules/Page.html">Page</a></li>
            
                <li><a href="../modules/Paragraph.html">Paragraph</a></li>
            
                <li><a href="../modules/PARAGRAPHS.html">PARAGRAPHS</a></li>
            
                <li><a href="../modules/ready.js.html">ready.js</a></li>
            
                <li><a href="../modules/ref.js.html">ref.js</a></li>
            
                <li><a href="../modules/REFS.js.html">REFS.js</a></li>
            
                <li><a href="../modules/String.html">String</a></li>
            
                <li><a href="../modules/UI.html">UI</a></li>
            
                <li><a href="../modules/window.html">window</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: /Users/philippeperret/Sites/table_narration/js/Ref.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/**
  * @module ref.js
  * 
  */

/**
  * Class pour une référence. Une référence est une instance qui permet de gérer
  * à la volée les références à d&#x27;autres fiches qui sont faites dans des textes
  * (ou plus rarement des titres). Une référence possède une fiche-cible ({Fiche})
  * qui correspond à l&#x27;instance {Fiche} visée par la référence (comprendre : 
  * “l&#x27;instance {Ref} fait référence à la cible {Fiche}).
  *
  * L&#x27;instance {Ref} peut posséder également une “porteuse”, qui est la fiche dans
  * laquelle cette référence est insérée. Elle est définie principalement lorsque
  * le texte de la porteuse doit être formaté pour affichage &quot;humain&quot;.
  *
  * L&#x27;instance {Ref} est capable de gérer toutes les situations, celle où la cible
  * n&#x27;est pas encore une fiche chargée, où la fichier porteuse de la référence
  * n&#x27;appartient pas au même livre que la fiche-cible de référence, etc.
  *
  * Notes
  * -----
  *   * Bien que l&#x27;instance {Ref} ne soit pas une {Fiche}, ses propriétés &#x60;id&#x60; et
  *     &#x60;type&#x60; sont les mêmes que sa fiche-cible. Mais pour la clarté, l&#x27;instance {Ref}
  *     possède les propriétés &#x60;cible_id&#x60; et &#x60;cible_type&#x60; qui sont des alias.
  *
  * @class Ref
  * @constructor
  * @param  {String} rid  Identifiant de la référence correspondant à &#x60;&lt;type&gt;-&lt;id&gt;&#x60;
  *                       de la cible.
  */
window.Ref = function(rid)
{
  var did = rid.split(&#x27;-&#x27;)
  /**
    * Type de la cible de la référence
    * @property {String} type
    * @final
    */
  this.type = this.cible_type = did[0]
  /**
    * Identifiant de la cible de la référence
    * @property {Number|String} id
    * @final
    */
  this.id   = this.cible_id   = did[1]
  
  /**
    * La fiche porteuse de la référence, c&#x27;est-à-dire qui la possède dans
    * son texte. La plupart du temps, c&#x27;est un {Paragraph} de page.
    * Notes
    * -----
    *   * Noter que cette propriété est dynamique elle change en fonction de
    *     la référence à écrire.
    *
    * @property {Fiche} porteuse
    */
  this.porteuse = null
  
  
  REFS.list[rid] = this
}
$.extend(Ref.prototype,{
  /**
    * Formate la balise pour affichage
    *
    * Notes
    * -----
    *   * Le formatage de la balise dépend de :
    *       * Si la cible est chargée ou non
    *       * Si la cible appartient au même livre ou non
    *       * Si le chargement de la cible peut se faire ou non
    *
    * @method formate
    * @param  {Fiche}   porteuse        La fiche qui doit recevoir la référence formatée
    * @param  {Array}   default_title   Le titre par défaut contenu dans la balise.
    * @param  {Boolean} skip_loading  
    *                   Pour le moment, ce paramètre n&#x27;est pas pris en compte : on ne
    *                   tente jamais de charger la fiche d&#x27;une référence inexistante
    *                   pour éviter les problèmes (vu que le formatage est un flux sur)
    *                   un ensemble de paragraphes.
    * @return {String} La balise formatée pour affichage.
    */
  formate:function(porteuse, default_title, skip_loading)
  {
    this.porteuse       = porteuse
    this.default_title  = default_title
    if(this.type==&#x27;para&#x27;) this.default_title = &#x27;&lt;span class=&quot;small&quot;&gt;&#x27;+this.default_title+&#x27; […]&lt;/span&gt;&#x27;
    this[&#x27;titres_for_&#x27;+(this.cible?&#x27;&#x27;:&#x27;non_&#x27;)+&#x27;loaded_cible&#x27;]()
    return this.to_html
  },
  
  
  /**
    * Formatage du titre pour une cible chargée
    * La méthode définit les valeurs &#x60;titre_same_book&#x60; et &#x60;titre_hors_book&#x60; de
    * la référence
    *
    * @method titres_for_loaded_cible
    *
    */
  titres_for_loaded_cible:function()
  {
    this.titre_same_book = this.human_type + &quot; “&quot;+this.titre_cible+&quot;”&quot;
    this.titre_hors_book = this.titre_same_book + this.mark_book
  },
  
  /**
    * Définit les titres pour une cible non chargée (simple)
    * Notes
    * -----
    *   * La cible n&#x27;étant pas chargée, on ne peut rien savoir d&#x27;elle, on met
    *     donc le même texte simple dans les deux propriétés &#x60;titre_same_book&#x60;
    *     et &#x60;titre_hors_book&#x60;.
    *
    * @method titres_for_non_loaded_cible
    */
  titres_for_non_loaded_cible:function()
  {
    var titre = &quot;[# &quot; + this.human_type + &quot; “&quot; + this.default_title + &quot;” #]&quot;
    this.titre_same_book = titre
    this.titre_hors_book = titre
  },
  
})

Object.defineProperties(Ref.prototype, {
  
  /* ---------------------------------------------------------------------
   *  MÉTHODES D&#x27;ÉCRITURE
   */
  
  /**
    * Retourne la balise [ref:...] à écrire dans le code du texte/titre
    * @property {String} to_balise
    * @final
    * @example
    *   jq.append(ref.to_balise)
    *   // Where &#x60;jq&#x60; is a DOMElement
    *   // And &#x60;ref&#x60; is a Ref Instance
    */
  &quot;to_balise&quot;:{
    get:function(){
      if(undefined == this._to_balise)
      {
        this._to_balise = &quot;[ref:&quot;+this.type+&quot;-&quot;+this.id+&quot;|&quot;+this.titre_cible+&quot;]&quot;
      }
      return this._to_balise
    }
  },
  
  /**
    * Retourne la balise HTML pour la référence
    * Notes
    * -----
    *   * C&#x27;est une propriété complexe, l&#x27;appeler sans parenthèses
    *   * Le titre (le contenu) de la balise doit avoir été construit avant
    *     d&#x27;appeler cette méthode
    * @method balise_html
    * @return {String} La balise à écrire dans le texte.
    */
  &quot;to_html&quot;:{
    get:function(){
      return &#x27;&lt;ref&#x27; +
                &#x27; class=&quot;&#x27;+this.class + &#x27;&quot;&#x27;+
                &#x27; onclick=&quot;FICHES.show(&#x27;+this.id+&#x27;, \&#x27;&#x27;+this.type+&#x27;\&#x27;, event)&quot;&#x27;+
                &#x27;&gt;&#x27; +
                this.titre_for_porteuse +
                &#x27;&lt;/ref&gt;&#x27;
    }    
  },
  
  /**
    * Appelée pour updater l&#x27;affichage de toutes les références lorsque la
    * fiche-cible est chargée.
    * Notes
    * -----
    *   * Propriété complexe =&gt; appeler sans parenthèses
    *
    * @method update
    */
  &quot;update&quot;:{
    get:function(){
      this.titres_for_loaded_cible()
    }
  },
  
  /* ---------------------------------------------------------------------
   *  MÉTHODES DE DONNÉES
   */
  
  /**
    * Instance Fiche de la cible de la référence
    * Notes
    * -----
    *   * WARNING: Cette propriété est mise à NULL même si l&#x27;instance Fiche
    *     existe, mais qu&#x27;elle n&#x27;est pas encore chargée.
    *
    * @property {Fiche} cible
    *
    */
  &quot;cible&quot;:{
    get:function(){
      if(undefined == this._cible &amp;&amp; FICHES.list[this.cible_id]){ 
        this._cible = get_fiche(this.cible_id)
        if(!this._cible.loaded) this._cible = null
      }
      return this._cible
    }
  },
  
  /**
    * Titre pour la fiche-porteuse (pour la composition de son texte affiché)
    * Notes
    * -----
    *   * Ce titre varie en fonction du fait que cible et porteuse se trouvent
    *     ou non dans le même livre.
    *
    * @property {String} titre_for_porteuse
    *
    */
  &quot;titre_for_porteuse&quot;:{
    get:function(){
      return this[&#x27;titre_&#x27;+(this.same_book?&#x27;same&#x27;:&#x27;hors&#x27;)+&#x27;_book&#x27;]
    }
  },
  
  /**
    * Retourne le titre pour la cible
    * Notes
    * -----
    *   * Ce titre dépend du type de la fiche. Pour un book, on prend son titre
    *     réel (&#x60;real_titre&#x60;), pour un paragraphe, on prend ses 50 premiers signes,
    *     et on prend le titre normal pour les chapitres et les pages.
    *   * Cette propriété ne doit être utilisée que pour une fiche-cible chargée.
    *
    * @property {String} titre_cible
    * @static
    */
  &quot;titre_cible&quot;:{
    get:function(){
      if(undefined == this._titre_cible)
      {
        this._titre_cible = function(ref){
          var fi = ref.cible
          switch(ref.type)
          {
          case &#x27;book&#x27; : return fi.real_titre || fi.titre
          case &#x27;para&#x27; :
            var extrait ;
            if(fi.texte.length &gt; 50) extrait = fi.texte.substring(0,50) + &#x27;[…]&#x27;
            else extrait = fi.texte
            return &#x27;&lt;span class=&quot;small&quot;&gt;&#x27;+extrait+&#x27;&lt;/span&gt;&#x27;
          default     : return fi.titre
          }
        }(this)
      }
      return this._titre_cible
    }
  },

  /**
    * Marque pour le livre à ajouter dans le titre hors book (quand la cible et
    * la fiche porteuse n&#x27;appartienne pas au même livre ou que l&#x27;une des deux fiches
    * n&#x27;est pas dans un livre)
    * @property {String} mark_book
    * @final
    */
  &quot;mark_book&quot;:{
    get:function(){
      if(undefined == this._mark_book)
      {
        if(this.book) this._mark_book = &quot; (livre “&quot;+(this.book.real_titre||this.book.titre)+&quot;”)&quot;
        else this._mark_book = &quot;&quot;
      }
      return this._mark_book
    }
  },
  
  /**
    * Renvoie true si la cible de la référence appartient au même livre que la
    * fiche porteuse (this.porteuse).
    *
    * Notes
    * -----
    *   * C&#x27;est une propriété complexe qui est recalculée à chaque nouvelle porteuse.
    *   * @rappel: this.porteuse est une instanceof {Fiche}
    *   * Si la cible de la référence courante n&#x27;est pas encore chargée, on ne peut
    *     pas déterminer son livre. La propriété est alors mise à false.
    *
    * @property {Boolean} same_book
    *
    */
  &quot;same_book&quot;:{
    get:function(){
      if(undefined == this.porteuse)
      {
        var err = &quot;La porteuse de la référence devrait être définie… Je ne peux rien faire.&quot; 
        F.error(err)
        throw err
      }
      if(!this.cible || !this.cible.loaded) return false
      else return this.cible.book_id == this.porteuse.book_id
    }
  },
  

  /**
    * Retourne la class pour la balise &#x60;ref&#x60; en tenant compte du fait que la
    * référence appartient ou non au même livre que la fiche porteuse contenant
    * la référence.
    * Notes
    * -----
    *   * C&#x27;est une propriété complexe car la valeur est redéfini à chaque nouvelle
    *     insertion dans le texte demandée.
    * @property {String} class
    */
  &quot;class&quot;:{
    get:function(){
      return this[&#x27;class_&#x27;+(this.same_book?&#x27;same&#x27;:&#x27;hors&#x27;)+&#x27;_book&#x27;]
    }
  },
  /**
    * Retourne la class pour la balise ref dans le cas d&#x27;une référence qui
    * appartient au même livre que la porteuse.
    * Notes
    * -----
    *   * C&#x27;est une propriété complexe qui redéfinit la valeur à chaque nouvelle
    *     fiche porteuse (paragraphe)
    * @property {String} class_same_book
    */
  &quot;class_same_book&quot;:{
    get:function(){
      return this.type+&quot;-&quot;+this.id+&quot;-in&quot;
    }
  },

  /**
    * Retourne la class pour la balise ref dans le cas d&#x27;une référence qui
    * N&#x27;appartient PAS au même livre que la porteuse.
    * Notes
    * -----
    *   * C&#x27;est une propriété complexe qui redéfinit la valeur à chaque nouvelle
    *     fiche porteuse (paragraphe)
    * @property {String} class_hors_book
    */
  &quot;class_hors_book&quot;:{
    get:function(){
      return this.type+&quot;-&quot;+this.id+&quot;-out&quot;
    }
  },

  /**
    * Titre construit pour la référence, tel qu&#x27;il apparaitra dans le texte.
    * Il dépend de l&#x27;état de chargement de la cible de la référence et de l&#x27;appartenance
    * ou non au même book que la porteuse.
    * Notes
    * -----
    *   * C&#x27;est une propriété complexe car sa (re)-définition peut faire varier
    *     toutes les balises références de la même référence.
    *
    * @property {String} titre
    */
  &quot;titre_same_book&quot;:{
    get:function(){
      return this._titre_same_book // doit avoir été défini avant
    },
    set:function(titre){
      this._titre_same_book = titre
      // On doit modifier toutes les références qu&#x27;on trouve
      $(&#x27;ref.&#x27;+this.class_same_book).html( titre )
    }
  },
  /**
    * Propriété similaire à la précédente, mais pour une référence n&#x27;appartenant
    * pas au livre de la porteuse.
    * @property {String} titre_hors_book
    */
  &quot;titre_hors_book&quot;:{
    get:function(){
      return this._titre_hors_book // doit avoir été défini avant
    },
    set:function(titre){
      this._titre_hors_book = titre
      // On doit modifier toutes les références qu&#x27;on trouve
      $(&#x27;ref.&#x27;+this.class_hors_book).html( titre )
    }
  },


  /**
    * Type humain de la référence (par exemple &quot;livre&quot; pour le type &#x27;book&#x27;)
    * Notes
    * -----
    *   * La valeur est sans capitale, pour pouvoir s&#x27;insérer dans le flux du texte
    *     ou entre parenthèses.
    * @property {String} human_type
    * @final
    */
  &quot;human_type&quot;:{
    get:function(){
      if(undefined == this._human_type) this._human_type = FICHES.datatype[this.type].hname;
      return this._human_type
    }
  },
  
  /**
    * Retourne l&#x27;instance {Fiche} de la référence courante
    *
    * Notes
    * -----
    *   * Pour obtenir cette information, il faut obligatoirement que
    *     la cible de la référence soit chargée.
    *
    * @property {Fiche} book
    *
    */
  &quot;book&quot;:{
    get:function(){ 
      if(undefined == this._book) this._book = this.cible.book 
      return this._book
    }
  },
  
  /**
    * Retourne l&#x27;identifiant du livre de la référence
    *
    * Notes
    * -----
    *   * Pour obtenir cette information, il faut obligatoirement que
    *     la cible de la référence soit chargée. Donc à n&#x27;utiliser que dans les
    *     méthodes/propriétés qui traitent du cas où la cible est loaded.
    *
    * @property book_id
    * @type {String|Number}
    */
  &quot;book_id&quot;:{
    get:function(){
      return this.book.id
    }
  }
  
})
    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
